<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trst - QR Payment</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Zen+Dots&display=swap" rel="stylesheet">
    <style>
        /* ปรับแต่งเพิ่มเติมให้เข้ากับธีมเดิม */
        .qr-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            margin-top: 20px;
        }

        .qr-image-container {
            background: white;
            padding: 15px;
            border-radius: 20px;
            width: fit-content;
            margin: 20px auto;
        }

        .qr-image-container img {
            width: 200px;
            display: block;
        }

        .upload-zone {
            border: 2px dashed rgba(139, 92, 246, 0.5);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: 0.3s;
            background: rgba(0, 0, 0, 0.2);
            margin-top: 20px;
        }

        .upload-zone:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        /* เอฟเฟกต์แสงม่วงฟุ้ง */
        .money-glow {
            font-size: 3.5rem;
            font-weight: 600;
            color: #fff;
            margin: 20px 0;
            display: none;
            text-shadow: 
                0 0 10px #bf40bf,
                0 0 20px #9400d3,
                0 0 40px #9400d3;
            font-family: 'Zen Dots';
            animation: glowPulse 2s infinite alternate;
        }

        @keyframes glowPulse {
            from { transform: scale(1); text-shadow: 0 0 20px #9400d3; }
            to { transform: scale(1.05); text-shadow: 0 0 40px #bf40bf; }
        }
    </style>
</head>
<body class="home-page">
    <div class="light-effect"></div>
    
    <div class="container">
        <header class="home-header">
            <a href="money.html" class="btn-text-back2">← กลับ</a>
            <h2 style="font-family: 'Zen Dots'; color: #8b5cf6;">PAYMENT</h2>
        </header>

        <div class="qr-card">
            <p class="signup-text">สแกนเพื่อชำระเงิน</p>
            
            <div class="qr-image-container" id="qr-box">
                <img src="qr.png" alt="QR PromptPay"> </div>

            <div id="moneyDisplay" class="money-glow">
                ฿<span id="amount">0.00</span>
            </div>

            <div id="upload-section">
                <p style="font-size: 0.9rem; color: #aaa; margin-bottom: 10px;">โอนเงินสำเร็จแล้ว อัปโหลดสลิปที่นี่</p>
                <div class="upload-zone" onclick="document.getElementById('slipInput').click()">
                    <span id="instruction" style="color: #8b5cf6;">คลิกเพื่อเลือกรูปสลิป</span>
                    <input type="file" id="slipInput" hidden accept="image/*" onchange="verify()">
                </div>
            </div>

            <div id="status" style="margin-top: 20px; font-size: 0.9rem; color: #888;">รอการตรวจสอบ...</div>
        </div>
    </div>

    <script>
        // ฟังก์ชันตรวจสอบสลิปจากไฟล์เดิมของคุณ
        async function verify() {
            const fileInput = document.getElementById('slipInput');
            const status = document.getElementById('status');
            const moneyDisplay = document.getElementById('moneyDisplay');
            const qrBox = document.getElementById('qr-box');
            const uploadSection = document.getElementById('upload-section');

            if (!fileInput.files[0]) return;

            status.innerText = "กำลังเชื่อมต่อธนาคาร...";
            status.style.color = "#8b5cf6";

            const formData = new FormData();
            formData.append('files', fileInput.files[0]);

            try {
                const response = await fetch('https://api.slipok.com/api/v1/main/log/upload', {
                    method: 'POST',
                    headers: {
                        'x-lib-apikey': 'b947d02a-899d-45ba-b321-74c7c0764f0b'
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    status.innerText = "เติมเงินสำเร็จ!";
                    status.style.color = "#00ff88";
                    
                    // ซ่อน QR และที่อัปโหลด แล้วโชว์แสงม่วง
                    qrBox.style.display = 'none';
                    uploadSection.style.display = 'none';
                    moneyDisplay.style.display = 'block';
                    countUp(result.data.amount);
                } else {
                    status.innerText = "ผิดพลาด: " + result.message;
                    status.style.color = "#ff4444";
                }
            } catch (err) {
                status.innerText = "ระบบขัดข้อง กรุณาลองใหม่";
                status.style.color = "#ff4444";
            }
        }

        // ฟังก์ชันตัวเลขวิ่ง
        function countUp(target) {
            let current = 0;
            const duration = 1500;
            const start = performance.now();
            
            function update(now) {
                const elapsed = now - start;
                const progress = Math.min(elapsed / duration, 1);
                current = progress * target;
                document.getElementById('amount').innerText = current.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }
    </script>
</body>
</html>